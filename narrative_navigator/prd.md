# 产品需求文档 (PRD): “叙事导航者”回忆录决策规划系统

## 1. 项目背景与目标

### 1.1 背景

传统大模型在长程回忆录访谈中常面临“遗忘主线”、“提问浅尝辄止”或“逻辑跳跃”等痛点。

### 1.2 核心目标

- **解耦规划与生成**：研发独立的访谈决策规划模块 (**Planner**)，与自然语言生成 (**NLG**) 解耦。
- **结构化记忆构建**：实时构建并维护动态的“**人生事件图谱**”。
- **智能导航决策**：通过深度挖掘 (*Depth-expansion*) 与广度跳转 (*Breadth-switching*) 博弈，平衡访谈的深度与覆盖率。

---

## 2. 核心架构与逻辑

### 2.1 核心规划层 (Core Planner)

**Planner** 通过“状态-价值-策略”三层架构实现决策：

1.  **状态感知层**：从回答中剥离人物、地点、时间等实体，进行槽位填充（如初恋节点的相识、情感冲突等）和时序锚定。
2.  **价值评估层**：监测“情绪能量”（语气词、情感强度）、信息密度及叙事独特性，为节点计算权重。
3.  **策略决策层**：基于当前图谱状态，决定下一步动作类型（深度、广度、纠偏）。

### 2.2 工作流 (Workflow)

- **接收响应**：获取用户回答并调用 **LLM API** 进行事件抽取。
- **更新图谱**：使用 **NetworkX** 更新事件图谱，计算当前覆盖率与深度。
- **导航输出**：根据节点状态执行 `Depth_Dive`（高价值事件深度追问）或 `Breadth_Switch`（低覆盖或疲劳时跳转）。

---

## 3. 功能需求

### 3.1 导航决策引擎

| 动作类型 | 策略逻辑 | 触发场景示例 |
| :--- | :--- | :--- |
| **深度挖掘** | 引导阀值、由“事”及“人”、感官触发 | “核心事件”槽位未满，且“情绪能量”高 |
| **广度跳转** | 物理跳转、社交网络跳转、时代快照、情感共振 | 当前节点信息密度衰减，或检测到用户话题疲劳 |
| **纠偏机制** | 矛盾检测与温和确认 | 发现新的叙事与已有节点存在逻辑/时间冲突 |

### 3.2 结构化指令集 (Planner Output)

**Planner** 不直接生成文本，而是输出包含以下字段的 **JSON** 指令：

- `Current_Focus`：锁定当前上下文（如：1992 创业阶段）。
- `Primary_Action`：规定动作类型（`Deep_Dive` / `Breadth_Switch`）。
- `Tactical_Goal`：明确要挖掘的信息点（如：提取失败时的情绪）。
- `Tone_Constraint`：约束语气（如：共情、支持）。

### 3.3 动态事件图谱可视化

- **时间轴森林图**：纵向展示生平时间轴，横向展示家庭、职业等维度。区分已挖透、提及未展开、预设待触达三种节点状态。
- **覆盖率仪表盘**：实时展示访谈在时间（童年、青年等）与维度（行为、细节、情感、反思）上的完备度。

---

## 4. 评估体系与仿真环境

### 4.1 用户模拟器

#### 4.1.1 设计目标

构建基于 **LLM** 的模拟受访者，用于在无需真实用户参与的情况下，对 **Baseline Agent**（无 Planner）和 **带 Planner 的完整系统** 进行自动化对比评估。

#### 4.1.2 Persona 类型定义

| 类型 | 特征 | 回答模式 | 测试目的 |
|:---|:---|:---|:---|
| **健谈型** | 表达欲强，细节丰富 | 每轮 200-300 字，主动延伸话题 | 验证系统信息提取与话题收敛能力 |
| **沉默型** | 回答简短，需要引导 | 每轮 20-50 字，被动回答 | 验证系统追问与深度挖掘能力 |
| **跳跃型** | 思维发散，容易跑题 | 频繁切换话题，关联性弱 | 验证 Planner 的话题回归与纠偏能力 |
| **逻辑型** | 结构清晰，条理分明 | 按时间/因果叙述，少情绪 | 验证系统对情感维度的覆盖 |

#### 4.1.3 模拟器实现架构

```
┌─────────────────────────────────────────────────────────────┐
│                      UserSimulator                          │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  Persona    │  │  Memory     │  │   Response  │         │
│  │  Profile    │→ │   Bank      │→ │  Generator  │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│         │               │               │                   │
│         ↓               ↓               ↓                   │
│  性格模板预设    预设人生故事库    LLM 驱动生成              │
└─────────────────────────────────────────────────────────────┘
```

#### 4.1.4 预设人生故事模板

每个 Persona 配套一份结构化的人生故事模板，涵盖：

```yaml
life_template:
  childhood:
    - 出生背景（年代、地点、家庭环境）
    - 童年趣事（1-2 个可展开事件）
  education:
    - 求学历程
    - 重要老师/同学
  career:
    - 第一份工作
    - 职业转折点
    - 成就或挫折
  family:
    - 婚恋经历
    - 子女教育
  turning_points:
    - 人生重大决策
    - 困难与克服
```

#### 4.1.5 对话生成逻辑

模拟器接收 Agent 问题后，执行以下流程：

1. **意图识别**：分析问题所属维度（时间/情感/细节/反思）
2. **记忆检索**：从预设故事库中匹配相关事件
3. **Persona 过滤**：根据类型调整回答长度、风格
4. **疲劳模拟**：长对话后逐步降低回答质量（测试系统适应能力）

#### 4.1.6 仿真测试流程

```python
# 伪代码示例
def run_simulation(agent_type, persona_type, max_turns=20):
    simulator = UserSimulator(persona_type)
    agent = BaselineAgent() if agent_type == 'baseline' else PlannerAgent()

    conversation_log = []
    for turn in range(max_turns):
        # Agent 发问
        question = agent.get_next_question()
        # 模拟器回答
        answer = simulator.generate_response(question)
        # Agent 处理
        agent.process_response(answer)

        conversation_log.append({
            'turn': turn,
            'question': question,
            'answer': answer,
            'action': agent.last_action  # Planner 决策动作
        })

    return evaluate(conversation_log)
```

#### 4.1.7 对比评估维度

| 指标 | Baseline Agent | 带 Planner Agent |
|:---|:---:|:---:|
| **话题覆盖率** | 随机/依赖用户引导 | 主动规划覆盖 |
| **平均对话深度** | 浅尝辄止 | 深度优先挖掘 |
| **话题切换平滑度** | 突兀 | 基于图谱平滑过渡 |
| **疲劳适应性** | 无法检测 | 检测并调整策略 |

#### 4.1.8 输出产物

每次仿真运行生成：
- **对话日志**：完整问答记录
- **事件图谱**：构建出的用户人生图谱
- **评估报告**：覆盖率、深度、连贯性量化分数

### 4.2 监控指标

- **话题覆盖率**：衡量预设大纲节点被触达的比例。
- **平均对话深度**：衡量对关键事件挖掘的细致程度。
- **逻辑连贯性**：评估话题切换是否平滑及是否存在矛盾。
